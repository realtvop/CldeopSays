<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲鳩曰</title>
    <link rel="icon" href="favicon.ico">
    <style>
        /* 字体定义 */
        @font-face {
            font-family: 'TwitterChirp';
            src: url('font/Chirp-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'TwitterChirp';
            src: url('font/Chirp-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'TwitterChirp';
            src: url('font/Chirp-Bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'TwitterChirp';
            src: url('font/Chirp-Heavy.woff2') format('woff2');
            font-weight: 900;
            font-style: normal;
        }

        /* 页面UI的主题颜色变量 */
        :root {
            --bg-color: #ffffff;
            --text-color: #0f1419;
            --secondary-text-color: #536471;
            --border-color: #ebeef0;
            --accent-color: #1d9bf0;
            --button-bg: #0f1419;
            --button-text: #ffffff;
        }

        /* 页面UI的暗色模式 (跟随设备) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #000000;
                --text-color: #e7e9ea;
                --secondary-text-color: #71767b;
                --border-color: #2f3336;
                --accent-color: #1d9bf0;
                --button-bg: #eff3f4;
                --button-text: #0f1419;
            }
        }

        body {
            font-family: 'TwitterChirp', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #canvas-container {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            font-size: 16px;
            font-family: 'TwitterChirp', sans-serif;
            resize: vertical;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: 2px solid var(--accent-color);
            border-color: transparent;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .actions select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
        }

        .actions button {
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            background-color: var(--button-bg);
            color: var(--button-text);
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .actions button:hover {
            opacity: 0.9;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #202324;
            color: #e7e9ea;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>
            雲鳩曰
            <a href="https://github.com/realtvop/CldeopSays"><img src="https://img.shields.io/github/stars/realtvop/CldeopSays?style=social"></a>
        </h1>
        <div id="canvas-container">
            <canvas id="tweetCanvas"></canvas>
        </div>
        <div class="controls">
            <textarea id="tweetText" placeholder="史？！"></textarea>
            <div class="actions">
                <select id="themeSelector">
                    <option value="device">跟随设备</option>
                    <option value="light">亮色模式</option>
                    <option value="dark">暗色模式</option>
                </select>
                <button id="copyBtn">复制图片</button>
                <button id="downloadBtn">下载 PNG</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素 ---
            const canvas = document.getElementById('tweetCanvas');
            const ctx = canvas.getContext('2d');
            const textarea = document.getElementById('tweetText');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const themeSelector = document.getElementById('themeSelector');
            const toast = document.getElementById('toast');

            // --- 常量和配置 ---
            // 提高DPI以增加输出图片的分辨率，使其更清晰
            const DPI = 3; 
            const PADDING = 20;
            const AVATAR_SIZE = 48;
            const USERNAME = '雲鳩';
            const HANDLE = '@Cldeop';
            const FONT_SIZE_TEXT = 20;
            const FONT_SIZE_USER = 15;
            const LINE_HEIGHT_TEXT = 1.4;
            
            // 从 verified.txt 中提取的 SVG 路径
            const VERIFIED_SVG_PATH = "M20.396 11c-.018-.646-.215-1.275-.57-1.816-.354-.54-.852-.972-1.438-1.246.223-.607.27-1.264.14-1.897-.131-.634-.437-1.218-.882-1.687-.47-.445-1.053-.75-1.687-.882-.633-.13-1.29-.083-1.897.14-.273-.587-.704-1.086-1.245-1.44S11.647 1.62 11 1.604c-.646.017-1.273.213-1.813.568s-.969.854-1.24 1.44c-.608-.223-1.267-.272-1.902-.14-.635.13-1.22.436-1.69.882-.445.47-.749 1.055-.878 1.688-.13.633-.08 1.29.144 1.896-.587.274-1.087.705-1.443 1.245-.356.54-.555 1.17-.574 1.817.02.647.218 1.276.574 1.817.356.54.856.972 1.443 1.245-.224.606-.274 1.263-.144 1.896.13.634.433 1.218.877 1.688.47.443 1.054.747 1.687.878.633.132 1.29.084 1.897-.136.274.586.705 1.084 1.246 1.439.54.354 1.17.551 1.816.569.647-.016 1.276-.213 1.817-.567s.972-.854 1.245-1.44c.604.239 1.266.296 1.903.164.636-.132 1.22-.447 1.68-.907.46-.46.776-1.044.908-1.681s.075-1.299-.165-1.903c.586-.274 1.084-.705 1.439-1.246.354-.54.551-1.17.569-1.816zM9.662 14.85l-3.429-3.428 1.293-1.302 2.072 2.072 4.4-4.794 1.347 1.246z";
            const verifiedIcon = new Path2D(VERIFIED_SVG_PATH);

            // --- 资源加载 ---
            const avatar = new Image();
            avatar.src = 'img/avatar.png';
            avatar.onerror = () => {
                console.error("头像加载失败！请确保 img/avatar.png 文件存在。");
                showToast("头像加载失败");
            };
            
            // 等待所有资源加载完毕, 然后首次绘制Canvas
            Promise.all([
                avatar.decode(),
                document.fonts.ready
            ]).then(drawCanvas).catch(err => {
                console.error("资源加载出错:", err);
                showToast("字体或图片资源加载出错");
            });

            // --- 事件监听 ---
            textarea.addEventListener('input', drawCanvas);
            themeSelector.addEventListener('change', drawCanvas); // 只需重绘Canvas
            downloadBtn.addEventListener('click', downloadImage);
            copyBtn.addEventListener('click', copyImage);

            // --- 核心函数 ---

            /**
             * 绘制整个 Canvas
             */
            function drawCanvas() {
                const text = textarea.value || textarea.placeholder;
                const theme = getCanvasTheme(); // 使用专门为Canvas获取主题的函数

                // --- 动态宽度计算 ---
                const MAX_WIDTH = 580;
                const MIN_WIDTH = 320; 

                ctx.font = `normal ${FONT_SIZE_TEXT}px TwitterChirp`;
                const textMetrics = ctx.measureText(text);

                ctx.font = `bold ${FONT_SIZE_USER}px TwitterChirp`;
                const usernameWidth = ctx.measureText(USERNAME).width;
                const verifiedIconWidth = (FONT_SIZE_USER * 1.1) + 4;
                const headerTopLineWidth = usernameWidth + verifiedIconWidth;
                
                ctx.font = `normal ${FONT_SIZE_USER}px TwitterChirp`;
                const handleWidth = ctx.measureText(HANDLE).width;
                const headerContentWidth = Math.max(headerTopLineWidth, handleWidth);

                const requiredHeaderWidth = PADDING + AVATAR_SIZE + 12 + headerContentWidth + PADDING;
                const requiredTextWidth = PADDING + textMetrics.width + PADDING;

                let canvasWidth = Math.max(requiredHeaderWidth, requiredTextWidth);
                canvasWidth = Math.min(canvasWidth, MAX_WIDTH);
                canvasWidth = Math.max(canvasWidth, MIN_WIDTH);
                
                // 1. 文本换行处理
                const textLines = processTextForDrawing(text, canvasWidth - PADDING * 2);
                
                // 2. 计算动态高度
                const headerHeight = PADDING + AVATAR_SIZE + 10;
                const textHeight = textLines.length * FONT_SIZE_TEXT * LINE_HEIGHT_TEXT;
                const calculatedHeight = headerHeight + textHeight + PADDING;

                // 3. 设置 Canvas 尺寸
                canvas.width = canvasWidth * DPI;
                canvas.height = calculatedHeight * DPI;
                ctx.scale(DPI, DPI);

                // 4. 绘制背景
                ctx.fillStyle = theme.bg;
                ctx.fillRect(0, 0, canvasWidth, calculatedHeight);

                // 5. 绘制头像
                const avatarY = PADDING;
                ctx.save();
                ctx.beginPath();
                ctx.arc(PADDING + AVATAR_SIZE / 2, avatarY + AVATAR_SIZE / 2, AVATAR_SIZE / 2, 0, Math.PI * 2, true);
                ctx.clip();
                ctx.drawImage(avatar, PADDING, avatarY, AVATAR_SIZE, AVATAR_SIZE);
                ctx.restore();

                // 6. 绘制用户名和 Handle
                const userX = PADDING + AVATAR_SIZE + 12;
                const userY = avatarY + FONT_SIZE_USER;
                
                ctx.font = `bold ${FONT_SIZE_USER}px TwitterChirp`;
                ctx.fillStyle = theme.text;
                ctx.fillText(USERNAME, userX, userY);

                const currentUsernameWidth = ctx.measureText(USERNAME).width;
                const verifiedIconX = userX + currentUsernameWidth + 4;

                ctx.save();
                ctx.translate(verifiedIconX, userY - FONT_SIZE_USER * 0.9);
                const scale = (FONT_SIZE_USER * 1.1) / 22;
                ctx.scale(scale, scale);
                ctx.fillStyle = theme.accent;
                ctx.fill(verifiedIcon);
                ctx.restore();

                ctx.font = `normal ${FONT_SIZE_USER}px TwitterChirp`;
                ctx.fillStyle = theme.secondaryText;
                ctx.fillText(HANDLE, userX, userY + FONT_SIZE_USER * 1.4);
                
                // 7. 绘制推文内容
                ctx.font = `normal ${FONT_SIZE_TEXT}px TwitterChirp`;
                ctx.fillStyle = theme.text;
                let textY = avatarY + AVATAR_SIZE + FONT_SIZE_TEXT + 10;
                textLines.forEach(line => {
                    ctx.fillText(line, PADDING, textY);
                    textY += FONT_SIZE_TEXT * LINE_HEIGHT_TEXT;
                });
            }

            /**
             * 处理文本以进行绘制，支持手动换行和自动换行。
             */
            function processTextForDrawing(text, maxWidth) {
                const allLines = [];
                const paragraphs = text.split('\n');
                ctx.font = `normal ${FONT_SIZE_TEXT}px TwitterChirp`;

                paragraphs.forEach(paragraph => {
                    if (paragraph === '') {
                        allLines.push('');
                        return;
                    }
                    const words = paragraph.split('');
                    let currentLine = '';
                    for (let i = 0; i < words.length; i++) {
                        const testLine = currentLine + words[i];
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && i > 0) {
                            allLines.push(currentLine);
                            currentLine = words[i];
                        } else {
                            currentLine = testLine;
                        }
                    }
                    allLines.push(currentLine);
                });
                return allLines;
            }

            /**
             * 获取Canvas的主题配置
             */
            function getCanvasTheme() {
                const selectedTheme = themeSelector.value;
                const isDeviceDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                const isDark = (selectedTheme === 'dark') || (selectedTheme === 'device' && isDeviceDark);

                if (isDark) {
                    return { bg: '#000000', text: '#e7e9ea', secondaryText: '#71767b', accent: '#1d9bf0' };
                } else {
                    return { bg: '#ffffff', text: '#0f1419', secondaryText: '#536471', accent: '#1d9bf0' };
                }
            }

            /**
             * 下载 Canvas 为 PNG 图片
             */
            function downloadImage() {
                const link = document.createElement('a');
                link.download = `tweet_by_${HANDLE}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }

            /**
             * 复制 Canvas 图片到剪贴板
             */
            function copyImage() {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ])
                        .then(() => showToast('图片已复制到剪贴板'))
                        .catch(err => {
                            console.error('复制失败:', err);
                            showToast('复制失败，浏览器不支持或未授权');
                        });
                    } else {
                        showToast('当前浏览器不支持复制图片功能');
                    }
                }, 'image/png');
            }
            
            /**
             * 显示一个提示消息
             */
            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        });
    </script>
</body>
</html>
